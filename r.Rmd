---
title: "Coronavirus Second Waves"
author: "Tyler DeGroff"
date: "6/29/2020"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r, message = FALSE}
rm(list = ls())
library(tidyverse)
library(readxl)
```

```{r}
# sauce: https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv

data <- read.csv("https://bit.ly/2Bk6bLV") %>% 
  filter(county != "Unknown") %>%
  mutate(date = as.Date(date)) %>%
  within(., fips[county == "New York City"] <- 36999) # treats NYC as a county
```

```{r}
# sauce: https://www2.census.gov/programs-surveys/popest/geographies/2019/state-geocodes-v2019.xlsx

fips.state <- read_excel("fips.state.xlsx", skip = 4) %>%
  rename(fips.state = "State (FIPS)", state = "Name") %>%
  select(fips.state, state) %>%
  filter(fips.state != "00") %>%
  arrange(fips.state)
```

```{r}
# sauce: https://www2.census.gov/programs-surveys/popest/geographies/2019/all-geocodes-v2019.xlsx

fips.county <- read_excel("fips.granular.xlsx", skip = 4) %>%
  rename(
    fips.state = "State Code (FIPS)", 
    fips.county = "County Code (FIPS)",
    county = "Area Name (including legal/statistical area description)"
  ) %>%
  mutate(fips = as.numeric(paste0(
    as.character(fips.state), 
    as.character(fips.county)
  ))) %>%
  filter(fips.county != "000") %>%
  select(fips, fips.state, fips.county, county)
```

```{r}
fips <- merge(x = fips.county, y = fips.state, by = "fips.state", all.x = TRUE)
fips <- fips[complete.cases(fips[, "state"]), ]
```

```{r}
# sauce: https://www2.census.gov/programs-surveys/popest/tables/2010-2019/counties/totals/co-est2019-annres.xlsx

pop <- read_excel("pop.xlsx", skip = 3) %>%
  rename(countyState = "...1", population = "2019") %>%
  filter(countyState != "United States") %>%
  select(countyState, population)

fips <- fips %>% mutate(countyState = paste0(county, ", ", state))
pop <- merge(x = pop, y = fips, by = "countyState", all.x = TRUE)
```

```{r}
pop.nyc <- pop %>%
  filter(
    fips == 36005 | # Bronx County (Bronx)
    fips == 36047 | # Kings County (Brooklyn)
    fips == 36061 | # New York County (Manhattan)
    fips == 36081 | # Queens County (Queens)
    fips == 36085   # Richmond County (Staten Island)
  )

pop <- rbind(
  pop,
  data.frame(
    fips.state = "36", # actual New York State state-level FIPS code
    fips.county = "999", # synthetic county-level FIPS code
    fips = "36999", # synthetic FIPS code
    county = "New York City",
    state = "New York",
    countyState = "New York, New York",
    population = sum(pop.nyc$population)
  )
)
```

```{r}
data <- merge(
  x = data, 
  y = pop %>% 
    select(fips, countyState, population), 
  by = "fips", 
  all.x = TRUE
)

data <- data %>%
  mutate(
    cases.percap = cases / population,
    cases.per100k = cases / (population / 100000),
    deaths.percap = deaths / population,
    deaths.per100k = deaths / (population / 100000)
  )
```

```{r, results = "hide"}
data <- data[order(data$date, data$state, data$county), ]
```

```{r}
data <- data %>%
  group_by(countyState) %>%
  mutate(
    cases.new = c(cases[1], diff(cases)),
    deaths.new = c(deaths[1], diff(deaths))
  )
```

```{r}
write_csv(data, "data.csv")
```

\newpage

# References

New York Times, The, Smith, M., Yourish, K., Almukhtar, S., Collins, K., Ivory, D., & Harmon, A. (2020). Coronavirus (Covid-19) Data in the United States [Cumulative counts of coronavirus cases in the United States, at the county level, over time (daily frequency).]. Github. https://bit.ly/2Zf5f3y

United States Census Bureau. (2010–2019, April 1–July 1). County Population Totals: 2010-2019 [Annual estimates of the county-level resident population, over time (annual frequency).]. United States Department of Commerce. https://bit.ly/2ZlIA5B

United States Census Bureau. (2019). 2019 Census Bureau Region and Division Codes and State FIPS Codes [Reference file for vintage 2019 Census Bureau state-level FIPS codes.]. United States Department of Commerce. https://bit.ly/2AiMxQa

United States Census Bureau. (2019). 2019 State, County, Minor Civil Division, and Incorporated Place FIPS Codes [Reference file for vintage 2019 Census Bureau county-level FIPS codes.]. United States Department of Commerce. https://bit.ly/2Vs2KJW